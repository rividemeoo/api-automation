pipeline {
    agent any
    
    environment {
        envVarValue = "env.PYTHON_ENVIRONMENT"
        EMAIL_TO = 'test_someone@loopup.co'
    }
    
    stages {
        stage('Checkout') {
            steps {
                // Checkout the repository
                checkout([$class: 'GitSCM', branches: [[name: '*/master']], 
                          userRemoteConfigs: [[url: 'https://github.com/rividemeoo/api-automation.git']]])
            }
        }

        stage('Run PowerShell Script') {
            steps { 
                    powershell '''
                    $inputFile = "Python\\tests\\config.py"
                    $replacementValue = "engr.properties"

                    (Get-Content $inputFile) | ForEach-Object {
                        if ($envVarValue -ne $null){
                        $_ -replace "test\\.properties", $envVarValue.properties
                        }
                        else{
                        $_ -replace "test\\.properties", $replacementValue
                        }
                    } | Set-Content $inputFile

                    echo "Config replacement complete."
                    echo "${envVarValue}"
                    '''
            }
        }

        stage('Build') {
            steps {
                bat 'python -m pip install -r requirements.txt'
            }
        }
        
        stage('Test') {
            steps {
                bat 'python -m pytest'
            }
        }
        
        // Add more stages as needed
        
    }

    post {
        failure {
            emailext body: 'Check console output at $BUILD_URL to view the results. \n\n ${CHANGES} \n\n -------------------------------------------------- \n${BUILD_LOG, maxLines=100, escapeHtml=false}', 
                    to: "${EMAIL_TO}", 
                    subject: 'Build failed in Jenkins: $PROJECT_NAME - #$BUILD_NUMBER'
        }
        unstable {
            emailext body: 'Check console output at $BUILD_URL to view the results. \n\n ${CHANGES} \n\n -------------------------------------------------- \n${BUILD_LOG, maxLines=100, escapeHtml=false}', 
                    to: "${EMAIL_TO}", 
                    subject: 'Unstable build in Jenkins: $PROJECT_NAME - #$BUILD_NUMBER'
        }
        changed {
            emailext body: 'Check console output at $BUILD_URL to view the results.', 
                    to: "${EMAIL_TO}", 
                    subject: 'Jenkins build is back to normal: $PROJECT_NAME - #$BUILD_NUMBER'
        }
    }
}